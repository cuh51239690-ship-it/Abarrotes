<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abarrotes "El Buen Precio"</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .user-menu {
            display: none;
        }
        .auth-buttons {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Navegaci√≥n -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">Abarrotes "El Buen Precio"</div>
                <ul class="nav-links">
                    <li><a href="#">Inicio</a></li>
                    <li><a href="#productos">Productos</a></li>
                    <li><a href="#ofertas">Ofertas</a></li>
                    <li><a href="#nosotros">Nosotros</a></li>
                    
                    <!-- Men√∫ cuando NO est√° logueado -->
                    <li class="auth-buttons" id="authButtons">
                        <a href="auth.html" class="btn-login">Iniciar Sesi√≥n</a>
                    </li>
                    
                    <!-- Men√∫ cuando S√ç est√° logueado -->
                    <li class="user-menu" id="userMenu">
                        <div class="user-dropdown">
                            <span id="userName">Usuario</span>
                            <div class="dropdown-content">
                                <a href="#" id="profileLink">Mi Perfil</a>
                                <a href="#" id="logoutLink">Cerrar Sesi√≥n</a>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="burger">
                    <div class="line1"></div>
                    <div class="line2"></div>
                    <div class="line3"></div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Icono del carrito -->
<div class="cart-icon" id="cartIcon">
    <i class="fas fa-shopping-cart"></i>
    <span class="cart-count" id="cartCount">0</span>
</div>

<!-- Modal del carrito -->
<div class="cart-modal" id="cartModal">
    <div class="cart-content">
        <div class="cart-header">
            <h2>üõí Tu Carrito de Compras</h2>
            <button class="close-cart" id="closeCart">&times;</button>
        </div>
        <div class="cart-body" id="cartBody">
            <!-- Los items del carrito aparecer√°n aqu√≠ -->
            <div class="empty-cart" id="emptyCart">
                <i class="fas fa-shopping-cart"></i>
                <p>Tu carrito est√° vac√≠o</p>
            </div>
            <div class="cart-items" id="cartItems"></div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <strong>Total: $<span id="cartTotal">0.00</span></strong>
            </div>
            <div class="cart-actions">
                <button class="btn btn-secondary" id="clearCart">Vaciar Carrito</button>
                <button class="btn btn-primary" id="checkout">Proceder al Pago</button>
            </div>
        </div>
    </div>
</div>

    <!-- Resto de tu contenido HTML... -->
    <div class="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Frutas y verduras frescas">
                <div class="carousel-caption">
                    <h2>Frutas y Verduras Frescas</h2>
                    <p>Productos frescos directamente del campo a tu mesa. Calidad garantizada.</p>
                    <a href="#" class="btn">Ver productos</a>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Despensa completa">
                <div class="carousel-caption">
                    <h2>Todo para tu Despensa</h2>
                    <p>Encuentra todo lo que necesitas en un solo lugar. Los mejores precios.</p>
                    <a href="#" class="btn">Hacer pedido</a>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://phantom-marca-mx.unidadeditorial.es/fa90489d3c875e492ba3e74d224e6dc2/resize/828/f/jpg/mx/assets/multimedia/imagenes/2024/06/18/17187191209739.jpg" alt="Ofertas especiales">
                <div class="carousel-caption">
                    <h2>Ofertas Especiales</h2>
                    <p>Aprovecha nuestras promociones de la semana. Descuentos incre√≠bles.</p>
                    <a href="#" class="btn">Ver ofertas</a>
                </div>
            </div>
        </div>
        <div class="carousel-controls">
            <div class="carousel-control active" data-index="0"></div>
            <div class="carousel-control" data-index="1"></div>
            <div class="carousel-control" data-index="2"></div>
        </div>
    </div>

      <!-- Secci√≥n de Video -->
    <section class="video-section">
        <div class="container">
            <h2 class="section-title">Conoce Nuestra Tienda</h2>
            <div class="video-container">
                <video id="storeVideo" poster="https://images.unsplash.com/photo-1566842600175-97dca3dfc3c7?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80">
                    <source src="https://www.youtube.com/shorts/rmT4rXvcjlQ" >
                    Tu navegador no soporta el elemento de video.
                </video>
                <div class="video-overlay" id="videoOverlay">
                    <div class="play-btn" id="playBtn">
                        <i class="fas fa-play"></i>
                    </div>
                    <h3>Tour Virtual por Nuestra Tienda</h3>
                    <p>Descubre nuestro amplio surtido de productos y las mejores ofertas</p>
                </div>
            </div>
        </div>
    </section>

<!-- Productos destacados -->
<section class="products">
    <div class="container">
        <h2 class="section-title">Productos Destacados</h2>
        <div class="product-grid">
            <div class="product-card" data-product-id="1">
                <div class="product-img">
                    <img src="https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" alt="Frutas y verduras">
                </div>
                <div class="product-info">
                    <h3>Canasta de Frutas</h3>
                    <p>Selecci√≥n de frutas de temporada</p>
                    <div class="product-price">$12.99</div>
                    <a href="#" class="btn add-to-cart" data-product-id="1">Agregar al carrito</a>
                </div>
            </div>
            
            <div class="product-card" data-product-id="2">
                <div class="product-img">
                    <img src="https://fanser.com/wp-content/uploads/2022/01/proceso-de-enlatado.jpg" alt="Productos enlatados">
                </div>
                <div class="product-info">
                    <h3>Variedad de Enlatados</h3>
                    <p>Conservas de la mejor calidad</p>
                    <div class="product-price">$8.50</div>
                    <a href="#" class="btn add-to-cart" data-product-id="2">Agregar al carrito</a>
                </div>
            </div>
            
            <div class="product-card" data-product-id="3">
                <div class="product-img">
                    <img src="https://static.wixstatic.com/media/7d0865_7b79ab5e9a8442fbad9291d98219287c~mv2.jpg/v1/fill/w_1000,h_667,al_c,q_85,usm_0.66_1.00_0.01/7d0865_7b79ab5e9a8442fbad9291d98219287c~mv2.jpg" alt="Granos b√°sicos">
                </div>
                <div class="product-info">
                    <h3>Granos y Semillas</h3>
                    <p>Arroz, frijol, lentejas y m√°s</p>
                    <div class="product-price">$6.75</div>
                    <a href="#" class="btn add-to-cart" data-product-id="3">Agregar al carrito</a>
                </div>
            </div>
            
            <div class="product-card" data-product-id="4">
                <div class="product-img">
                    <img src="https://www.webconsultas.com/sites/default/files/styles/wch_image_schema/public/media/0d/articulos/productos-lacteos.jpg" alt="L√°cteos">
                </div>
                <div class="product-info">
                    <h3>Productos L√°cteos</h3>
                    <p>Leche, queso, yogur y mantequilla</p>
                    <div class="product-price">$10.25</div>
                    <a href="#" class="btn add-to-cart" data-product-id="4">Agregar al carrito</a>
                </div>
            </div>
        </div>
    </div>
</section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Sobre Nosotros</h3>
                    <p>Abarrotes "El Buen Precio" es tu tienda de confianza para todos los productos de tu despensa. Calidad y precios bajos siempre.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Enlaces R√°pidos</h3>
                    <ul>
                        <li><a href="#">Inicio</a></li>
                        <li><a href="#">Productos</a></li>
                        <li><a href="#">Ofertas</a></li>
                        <li><a href="#">Nosotros</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Cont√°ctanos</h3>
                    <p>üìû Tel: (123) 456-7890</p>
                    <p>‚úâÔ∏è Email: info@elbuenprecio.com</p>
                    <div class="social-links">
                        <a href="#">üìò</a>
                        <a href="#">üì∏</a>
                        <a href="#">üê¶</a>
                    </div>
                </div>
                
                <div class="footer-section location">
                    <h3>Ubicaci√≥n</h3>
                    <p>üìç Av. Principal #123, Colonia Centro</p>
                    <p>Ciudad, Estado, C.P. 12345</p>
                    <!-- Mapa de ubicaci√≥n (puedes reemplazar el src con el de tu ubicaci√≥n real) -->
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15050.281612218277!2d-99.167575!3d19.42847!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85d1ff35f5bd1563%3A0x6c366f0e2de02ff7!2sEl%20Z%C3%B3calo%2C%20Centro%2C%20Ciudad%20de%20M%C3%A9xico%2C%20CDMX!5e0!3m2!1ses!2smx!4v1622747144592!5m2!1ses!2smx" allowfullscreen="" loading="lazy"></iframe>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Abarrotes "El Buen Precio". Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    <script>
        // Configuraci√≥n
        const API_URL = 'http://localhost:3000/api';

        // Clase para manejar autenticaci√≥n
        class AuthService {
            static setToken(token) {
                localStorage.setItem('token', token);
            }

            static getToken() {
                return localStorage.getItem('token');
            }

            static removeToken() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }

            static setUser(user) {
                localStorage.setItem('user', JSON.stringify(user));
            }

            static getUser() {
                const user = localStorage.getItem('user');
                return user ? JSON.parse(user) : null;
            }

            static isAuthenticated() {
                return !!this.getToken();
            }

            // Verificar token con el servidor
            static async verifyAuth() {
                try {
                    const token = this.getToken();
                    if (!token) return false;

                    const response = await fetch(`${API_URL}/auth/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.success;
                    }
                    return false;
                } catch (error) {
                    console.error('Error verificando auth:', error);
                    return false;
                }
            }
        }

        // Actualizar la interfaz seg√∫n autenticaci√≥n
        async function updateAuthUI() {
            const isAuthenticated = await AuthService.verifyAuth();
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');

            if (isAuthenticated) {
                const user = AuthService.getUser();
                if (user) {
                    userName.textContent = user.nombre;
                }
                authButtons.style.display = 'none';
                userMenu.style.display = 'block';
            } else {
                authButtons.style.display = 'flex';
                userMenu.style.display = 'none';
                // Si no est√° autenticado y est√° en auth.html, dejarlo ah√≠
                if (window.location.pathname.includes('auth.html')) {
                    return;
                }
            }
        }

        // Logout
        document.addEventListener('DOMContentLoaded', function() {
            // Actualizar UI al cargar
            updateAuthUI();

            // Manejar logout
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    AuthService.removeToken();
                    window.location.href = 'index.html';
                });
            }

            // Funcionalidad del men√∫ hamburguesa
            const burger = document.querySelector('.burger');
            const nav = document.querySelector('.nav-links');
            
            if (burger) {
                burger.addEventListener('click', () => {
                    nav.classList.toggle('active');
                });
            }

            // Verificar autenticaci√≥n en cada p√°gina
            if (window.location.pathname.includes('auth.html') && AuthService.isAuthenticated()) {
                window.location.href = 'index.html';
            }
        });

        // Funcionalidad del carrusel (tu c√≥digo existente)
        const carouselItems = document.querySelectorAll('.carousel-item');
        const carouselControls = document.querySelectorAll('.carousel-control');
        let currentIndex = 0;
        
        function showSlide(index) {
            carouselItems.forEach(item => item.classList.remove('active'));
            carouselControls.forEach(control => control.classList.remove('active'));
            
            carouselItems[index].classList.add('active');
            carouselControls[index].classList.add('active');
            currentIndex = index;
        }
        
        if (carouselControls.length > 0) {
            carouselControls.forEach(control => {
                control.addEventListener('click', () => {
                    const index = parseInt(control.getAttribute('data-index'));
                    showSlide(index);
                });
            });
            
            setInterval(() => {
                currentIndex = (currentIndex + 1) % carouselItems.length;
                showSlide(currentIndex);
            }, 5000);
        }
    </script>
    <script>
    // Configuraci√≥n

    class CartManager {
        constructor() {
            this.cart = [];
            this.user = null;
            this.init();
        }

        init() {
            this.loadUser();
            this.loadCart();
            this.setupEventListeners();
        }

        loadUser() {
            const userData = localStorage.getItem('user');
            if (userData) {
                this.user = JSON.parse(userData);
                console.log('üë§ Usuario cargado:', this.user);
            } else {
                console.log('‚ö†Ô∏è No hay usuario logueado');
            }
        }

        async loadCart() {
            if (!this.user) {
                console.log('‚ö†Ô∏è No se puede cargar carrito - usuario no logueado');
                return;
            }
            
            try {
                console.log('üõí Cargando carrito para usuario:', this.user.id);
                const response = await fetch(`${API_URL}/cart/${this.user.id}`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    this.cart = data.cart;
                    this.updateCartUI();
                    console.log('‚úÖ Carrito cargado:', this.cart);
                } else {
                    console.error('‚ùå Error cargando carrito:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error cargando carrito:', error);
                // Si hay error, inicializar carrito vac√≠o
                this.cart = [];
                this.updateCartUI();
            }
        }

        setupEventListeners() {
            // Icono del carrito
            document.getElementById('cartIcon').addEventListener('click', () => {
                this.openCart();
            });

            // Cerrar carrito
            document.getElementById('closeCart').addEventListener('click', () => {
                this.closeCart();
            });

            // Vaciar carrito
            document.getElementById('clearCart').addEventListener('click', () => {
                this.clearCart();
            });

            // Checkout
            document.getElementById('checkout').addEventListener('click', () => {
                this.checkout();
            });

            // Cerrar modal al hacer click fuera
            document.getElementById('cartModal').addEventListener('click', (e) => {
                if (e.target.id === 'cartModal') {
                    this.closeCart();
                }
            });

            // Botones "Agregar al carrito"
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart')) {
                    e.preventDefault();
                    const productId = e.target.getAttribute('data-product-id');
                    console.log('üõí Agregando producto ID:', productId);
                    this.addToCart(parseInt(productId), 1);
                }
            });
        }

        async addToCart(productId, quantity = 1) {
            if (!this.user) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para agregar productos al carrito');
                window.location.href = 'auth.html';
                return;
            }

            console.log('üõí Enviando al servidor:', {
                userId: this.user.id,
                productId: productId,
                quantity: quantity
            });

            try {
                const response = await fetch(`${API_URL}/cart/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: this.user.id,
                        productId: productId,
                        quantity: quantity
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì® Respuesta del servidor:', data);
                
                if (data.success) {
                    this.cart = data.cart;
                    this.updateCartUI();
                    this.showNotification('‚úÖ Producto agregado al carrito');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå Error agregando al carrito:', error);
                alert('Error al agregar producto al carrito: ' + error.message);
            }
        }

        async updateQuantity(productId, newQuantity) {
            if (!this.user) return;

            try {
                const response = await fetch(`${API_URL}/cart/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: this.user.id,
                        productId: productId,
                        quantity: newQuantity
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.cart = data.cart;
                    this.updateCartUI();
                }
            } catch (error) {
                console.error('Error actualizando cantidad:', error);
            }
        }

        async removeFromCart(productId) {
            if (!this.user) return;

            try {
                const response = await fetch(`${API_URL}/cart/remove`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: this.user.id,
                        productId: productId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.cart = data.cart;
                    this.updateCartUI();
                    this.showNotification('üóëÔ∏è Producto eliminado del carrito');
                }
            } catch (error) {
                console.error('Error eliminando del carrito:', error);
            }
        }

        async clearCart() {
            if (!this.user || this.cart.length === 0) return;

            if (confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
                try {
                    const response = await fetch(`${API_URL}/cart/clear/${this.user.id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.cart = [];
                        this.updateCartUI();
                        this.showNotification('üõí Carrito vaciado');
                    }
                } catch (error) {
                    console.error('Error vaciando carrito:', error);
                }
            }
        }

        updateCartUI() {
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const cartItems = document.getElementById('cartItems');
            const emptyCart = document.getElementById('emptyCart');

            // Actualizar contador
            const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;

            // Actualizar total
            const total = this.cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            cartTotal.textContent = total.toFixed(2);

            // Mostrar/ocultar carrito vac√≠o
            if (this.cart.length === 0) {
                emptyCart.style.display = 'block';
                cartItems.innerHTML = '';
            } else {
                emptyCart.style.display = 'none';
                cartItems.innerHTML = this.cart.map(item => `
                    <div class="cart-item">
                        <img src="${item.imagen}" alt="${item.nombre}" class="cart-item-image">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.nombre}</div>
                            <div class="cart-item-price">$${item.precio} c/u</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn" onclick="cartManager.updateQuantity(${item.productId}, ${item.quantity - 1})">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                                   onchange="cartManager.updateQuantity(${item.productId}, parseInt(this.value))">
                            <button class="quantity-btn" onclick="cartManager.updateQuantity(${item.productId}, ${item.quantity + 1})">+</button>
                            <button class="remove-item" onclick="cartManager.removeFromCart(${item.productId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        openCart() {
            if (!this.user) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para ver el carrito');
                window.location.href = 'auth.html';
                return;
            }
            document.getElementById('cartModal').style.display = 'block';
        }

        closeCart() {
            document.getElementById('cartModal').style.display = 'none';
        }

        checkout() {
            if (this.cart.length === 0) {
                alert('‚ö†Ô∏è Tu carrito est√° vac√≠o');
                return;
            }

            const total = this.cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            alert(`üéâ ¬°Gracias por tu compra!\nTotal: $${total.toFixed(2)}\n\nTu pedido ser√° procesado pronto.`);
            this.clearCart();
            this.closeCart();
        }

        showNotification(message) {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 3000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
    }

    // Inicializar el carrito cuando la p√°gina cargue
    let cartManager;
    document.addEventListener('DOMContentLoaded', function() {
        cartManager = new CartManager();
        
        // Tambi√©n actualiza la UI de autenticaci√≥n
        updateAuthUI();
    });

    // Funci√≥n para actualizar la UI de autenticaci√≥n (si la tienes)
    function updateAuthUI() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const authButtons = document.getElementById('authButtons');
        const userMenu = document.getElementById('userMenu');
        const userName = document.getElementById('userName');

        if (user) {
            if (userName) userName.textContent = user.nombre;
            if (authButtons) authButtons.style.display = 'none';
            if (userMenu) userMenu.style.display = 'block';
        } else {
            if (authButtons) authButtons.style.display = 'flex';
            if (userMenu) userMenu.style.display = 'none';
        }
    }
</script>
</body>
</html>